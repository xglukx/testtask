{% extends 'base.html' %}

{% block title %}Home - Comment System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h1 class="text-center mb-4">Welcome to Comment System</h1>

        <!-- Post Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Create a New Post</h5>
                <form method="post" enctype="multipart/form-data" action="{% url 'create_post' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="image" class="form-label">Image (optional)</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Create Post</button>
                </form>
            </div>
        </div>

        <!-- Posts List -->
        {% for post in posts %}
        <div class="post-card">
            <h2>{{ post.title }}</h2>
            <p class="text-muted">Posted on {{ post.created_at|date:"F j, Y, g:i a" }}</p>
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="{{ post.title }}" class="post-image">
            {% endif %}
            <p>{{ post.description }}</p>

            <!-- Comment Form -->
            <form method="post" action="{% url 'add_comment' post.id %}" class="mb-3">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" name="content" class="form-control" placeholder="Add a comment..." required>
                    <button type="submit" class="btn btn-primary">Comment</button>
                </div>
            </form>

            <!-- Comments List -->
            <div class="comments-section">
                <h5>Comments ({{ post.comments.count }})</h5>
                {% for comment in post.comments.all %}
                <div class="comment-card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="comment-content">
                            <p class="mb-1">{{ comment.content }}</p>
                            <small class="text-muted">{{ comment.created_at|date:"F j, Y, g:i a" }}</small>
                        </div>
                        <div class="upvote-section">
                            <button class="btn btn-link upvote-btn" onclick="upvoteComment({{ comment.id }})">
                                <i class="fas fa-arrow-up"></i>
                                <span class="upvote-count">{{ comment.upvotes }}</span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="text-center">
            <p>No posts yet. Be the first to create one!</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://kit.fontawesome.com/a076d05399.js"></script>
<script>
function upvoteComment(commentId) {
    fetch(`/upvote/${commentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const upvoteCount = document.querySelector(`button[onclick="upvoteComment(${commentId})"] .upvote-count`);
            upvoteCount.textContent = data.upvotes;
            const upvoteBtn = document.querySelector(`button[onclick="upvoteComment(${commentId})"]`);
            upvoteBtn.classList.add('active');
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}
